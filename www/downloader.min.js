function createEvent(name,data){data=data||[];var event=document.createEvent("Event");event.initEvent(name);event.name=name;event.data=data;var log=name;if(data[0])log+=" : "+data[0];return event}var Downloader={localFolder:null,fileSystem:null,unzipQueue:[],downloadQueue:[],fileObjects:[],fileObjectInProgress:null,fileObjectInUnzipProgress:null,wifiOnly:false,autoUnzip:false,autoDelete:true,autoCheck:false,noMedia:true,loading:false,unzipping:false,initialized:false,initialize:function(options){Downloader.setFolder(options.folder);if(typeof options.unzip!="undefined"){Downloader.setAutoUnzip(options.unzip)}if(typeof options.delete!="undefined"){Downloader.setDelteAfterUnzip(options.delete)}if(typeof options.check!="undefined"){Downloader.setAutoCheck(options.check)}if(typeof options.wifiOnly!="undefined"){Downloader.setWifiOnly(options.wifiOnly)}if(typeof options.noMedia!="undefined"){Downloader.setNoMedia(options.noMedia)}document.addEventListener("DOWNLOADER_gotFileSystem",Downloader.onGotFileSystem,false);document.addEventListener("DOWNLOADER_gotFolder",Downloader.onGotFolder,false);document.addEventListener("DOWNLOADER_downloadSuccess",Downloader.onDownloadSuccess,false);document.addEventListener("DOWNLOADER_unzipSuccess",Downloader.onUnzipSuccess,false);document.addEventListener("DOWNLOADER_fileCheckSuccess",Downloader.onCheckSuccess,false);Downloader.getFilesystem()},load:function(url,md5){md5=md5||null;if(!Downloader.isInitialized()){document.addEventListener("DOWNLOADER_initialized",function onInitialized(event){event.target.removeEventListener("DOWNLOADER_initialized",onInitialized,false);Downloader.load(url,md5)},false);return}var fileObject={url:url,name:url.replace(/^.*\//,""),md5:md5};Downloader.downloadQueue.push(fileObject);if(!Downloader.isLoading()){Downloader.loadNextInQueue()}},unzip:function(fileName){Downloader.unzipQueue.push(fileName);if(!Downloader.isUnzipping()){Downloader.unzipNextInQueue()}},loadNextInQueue:function(){if(Downloader.downloadQueue.length>0){Downloader.loading=true;var fileObject=Downloader.downloadQueue.shift();Downloader.fileObjectInProgress=fileObject;Downloader.transferFile(fileObject);return true}return false},unzipNextInQueue:function(){if(Downloader.unzipQueue.length>0){Downloader.unzipping=true;var fileObject=Downloader.unzipQueue.shift();Downloader.fileObjectInUnzipProgress=fileObject;Downloader._unzip(fileObject);return true}return false},transferFile:function(fileObject){var filePath=Downloader.localFolder.toURL()+"/"+fileObject.name;var transfer=new FileTransfer;transfer.onprogress=function(progressEvent){if(progressEvent.lengthComputable){var percentage=Math.floor(progressEvent.loaded/progressEvent.total*100);document.dispatchEvent(createEvent("DOWNLOADER_downloadProgress",[percentage,fileObject.name]))}};transfer.download(fileObject.url,filePath,function(entry){document.dispatchEvent(createEvent("DOWNLOADER_downloadSuccess",[entry]))},function(error){document.dispatchEvent(createEvent("DOWNLOADER_downloadError",[error]))})},_unzip:function(fileName){var folderUrl=Downloader.localFolder.toURL();zip.unzip(folderUrl+"/"+fileName,folderUrl,function(code){if(code==0){document.dispatchEvent(createEvent("DOWNLOADER_unzipSuccess",[fileName]))}else{document.dispatchEvent(createEvent("DOWNLOADER_unzipError",[fileName]))}},function(progressEvent){var percentage=Math.floor(progressEvent.loaded/progressEvent.total*100);document.dispatchEvent(createEvent("DOWNLOADER_unzipProgress",[percentage,fileName]))})},check:function(fileName,md5){var folder=Downloader.localFolder;folder.getFile(fileName,{create:false,exclusive:false},function onGotFileToCheck(entry){md5chksum.file(entry,function(md5sum){if(md5sum==md5){document.dispatchEvent(createEvent("DOWNLOADER_fileCheckSuccess",[md5sum,fileName]))}else{document.dispatchEvent(createEvent("DOWNLOADER_fileCheckFailed",[md5sum,md5,fileName]))}},function(error){document.dispatchEvent(createEvent("DOWNLOADER_fileCheckError",[error]))})},function onGetFileError(error){document.dispatchEvent(createEvent("DOWNLOADER_getFileError",[error]))})},removeFile:function(fileName){var folder=Downloader.localFolder;folder.getFile(fileName,{create:false,exclusive:false},function onGotFileToDelete(entry){entry.remove(function onRemoved(){document.dispatchEvent(createEvent("DOWNLOADER_fileRemoved",[entry]))},function onRemoveError(){document.dispatchEvent(createEvent("DOWNLOADER_fileRemoveError",[entry]))})},function onGetFileError(error){document.dispatchEvent(createEvent("DOWNLOADER_getFileError",[error]))})},isLoading:function(){return Downloader.loading},isUnzipping:function(){return Downloader.unzipping},isInitialized:function(){return Downloader.initialized},isWifiOnly:function(){return Downloader.wifiOnly},isAutoUnzip:function(){return Downloader.autoUnzip},isAutoDelete:function(){return Downloader.autoDelete},isAutoCheck:function(){return Downloader.autoCheck},isWifiConnection:function(){var networkState=navigator.connection.type;if(networkState==Connection.WIFI){return true}return false},isZipFile:function(fileName){if(fileName.match(/\.zip$/)){return true}return false},isNoMedia:function(){return Downloader.noMedia},setFolder:function(folder){Downloader.localFolder=folder},setWifiOnly:function(wifionly){Downloader.wifiOnly=wifionly},setNoMedia:function(noMedia){Downloader.noMedia=noMedia},setAutoUnzip:function(unzip){Downloader.autoUnzip=unzip},setAutoCheck:function(check){Downloader.autoCheck=check},setDelteAfterUnzip:function(del){Downloader.autoDelete=del},getFilesystem:function(){window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem;window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(fileSystem){document.dispatchEvent(createEvent("DOWNLOADER_gotFileSystem",[fileSystem]))},function(error){document.dispatchEvent(createEvent("DOWNLOADER_error",[error]))})},getFolder:function(fileSystem,folderName){fileSystem.root.getDirectory(folderName,{create:true,exclusive:false},function(folder){document.dispatchEvent(createEvent("DOWNLOADER_gotFolder",[folder]))},function(error){document.dispatchEvent(createEvent("DOWNLOADER_error",[error]))})},touchNoMedia:function(){var folder=Downloader.localFolder;folder.getFile(".nomedia",{create:true,exclusive:false},function onTouchNoMediaFile(entry){},function onTouchNoMediaFileError(error){document.dispatchEvent(createEvent("DOWNLOADER_getFileError",[error]))})},onDownloadSuccess:function(event){var entry=event.data[0];if(Downloader.isAutoCheck()){var md5=Downloader.fileObjectInProgress.md5;Downloader.check(entry.name,md5)}else if(Downloader.isAutoUnzip()&&Downloader.isZipFile(entry.name)){Downloader.unzip(entry.name)}if(!Downloader.loadNextInQueue()){Downloader.loading=false;Downloader.fileObjectInProgress=null}},onUnzipSuccess:function(event){var fileName=event.data[0];if(Downloader.isAutoDelete()){Downloader.removeFile(fileName)}if(!Downloader.unzipNextInQueue()){Downloader.unzipping=false;Downloader.fileObjectInUnzipProgress=null}},onCheckSuccess:function(event){var fileName=event.data[1];if(Downloader.isAutoUnzip()&&Downloader.isZipFile(fileName)){Downloader.unzip(fileName)}},onGotFileSystem:function(event){event.target.removeEventListener(event.name,Downloader.onGotFileSystem);var fileSystem=event.data[0];Downloader.fileSystem=fileSystem;Downloader.getFolder(fileSystem,Downloader.localFolder)},onGotFolder:function(event){event.target.removeEventListener(event.name,Downloader.onGotFolder);var folder=event.data[0];Downloader.localFolder=folder;Downloader.initialized=true;if(Downloader.isNoMedia()){Downloader.touchNoMedia()}document.dispatchEvent(createEvent("DOWNLOADER_initialized"))},"interface":{init:function(options){if(!options.folder){console.error("You have to set a folder to store the downloaded files into.");return}options=options||{};Downloader.initialize(options)},get:function(url,md5){if(!url){console.error("You have to specify a url where the file is located you wanna download");return}if(Downloader.isWifiOnly()&&!Downloader.isWifiConnection()){document.dispatchEvent(createEvent("DOWNLOADER_noWifiConnection"));return}Downloader.load(url,md5)},getMultipleFiles:function(list){if(Downloader.isWifiOnly()&&!Downloader.isWifiConnection()){document.dispatchEvent(createEvent("DOWNLOADER_noWifiConnection"));return}for(var i=0;i<list.length;i++){var fileObject=list[i];Downloader.load(fileObject.url,fileObject.md5)}}}};module.exports=Downloader.interface;